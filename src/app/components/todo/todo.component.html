<p-card header="Todo List" styleClass="todo-card">
  <!-- Error Message -->
  @if (error$ | async; as error) {
  <p-message
    severity="error"
    [text]="error"
    styleClass="error-message"
  ></p-message>
  }

  <!-- Todo Form (Reactive) -->
  <form [formGroup]="todoForm" (ngSubmit)="onSubmit()" class="todo-form">
    <p-inputGroup>
      <input
        type="text"
        pInputText
        formControlName="title"
        [placeholder]="editingTodo ? 'Update todo...' : 'Enter a new todo...'"
        class="todo-input"
        [class.ng-invalid]="isTitleInvalid"
      />
      <button
        pButton
        type="submit"
        [icon]="editingTodo ? 'pi pi-check' : 'pi pi-plus'"
        [label]="editingTodo ? 'Update' : 'Add'"
        [disabled]="todoForm.invalid"
      ></button>
      @if (editingTodo) {
      <button
        pButton
        type="button"
        icon="pi pi-times"
        label="Cancel"
        severity="secondary"
        (click)="cancelEdit()"
      ></button>
      }
    </p-inputGroup>
    @if (isTitleInvalid) {
    <small class="p-error">Title is required and cannot be empty.</small>
    }
  </form>

  <!-- Loading Indicator -->
  @if (loading$ | async) {
  <div class="loading-container">
    <p-progressSpinner
      styleClass="loading-spinner"
      strokeWidth="4"
      animationDuration=".5s"
    ></p-progressSpinner>
    <span class="loading-text">Loading...</span>
  </div>
  }

  <!-- Todo List -->
  <div class="todo-list">
    @for (todo of todos$ | async; track todo.id) {
    <div class="todo-item" [class.completed]="todo.completed">
      <p-checkbox
        [binary]="true"
        [value]="todo.completed"
        (click)="onToggleTodo(todo.id)"
        [inputId]="'todo-' + todo.id"
      ></p-checkbox>

      @if (editingTodoId === todo.id) {
      <input
        type="text"
        pInputText
        [formControl]="$any(inlineEditForm.get('title'))"
        (keydown)="onEditKeydown($event, todo.id)"
        (blur)="onSaveInlineEdit(todo.id)"
        class="edit-input"
        autofocus
      />
      } @else {
      <span
        class="todo-title"
        [class.completed-text]="todo.completed"
        (dblclick)="onStartInlineEdit(todo)"
      >
        {{ todo.title }}
      </span>
      }

      <div class="todo-actions">
        <button
          pButton
          type="button"
          icon="pi pi-pencil"
          severity="info"
          [text]="true"
          (click)="startEdit(todo)"
          class="edit-btn"
          pTooltip="Edit in form"
        ></button>
        <button
          pButton
          type="button"
          icon="pi pi-trash"
          severity="danger"
          [text]="true"
          (click)="onDeleteTodo(todo.id)"
          class="delete-btn"
        ></button>
      </div>
    </div>
    } @empty { @if (!(loading$ | async)) {
    <div class="empty-state">
      <i class="pi pi-inbox"></i>
      <p>No todos yet. Add one above!</p>
    </div>
    } }
  </div>
</p-card>
